<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" type="text/css" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/main.css">
        <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.9.0/css/all.css">

        <title>Soup Launcher</title>
    </head>

    <body id="bawdy">
        <nav class="navbar navbar-light bg-light sticky-top" id="navbar">
            <span class="navbar-brand" onclick="longCatToggle()" style="cursor: crosshair;">Soup Launcher</span>
            <i onclick="openUserMenu()" oncontextmenu="openUserMenu()" class="fas fa-cog settings-cog"></i>
            <img id="profpic" class="profpic" src="">
        </nav>
        <br>

        <div class="grid-container" id="instances">
                
        </div>

        <script>
            console.log('%cStop! Only use this if you know what you are doing!', 'color: red; font-size: 25px; font-weight: bold;');
            console.log('%cIf someone told you to paste something in here, do not do it!', 'color: red; font-size: 20px; font-weight: bold;');
            
            const timeout = ms => new Promise(res => setTimeout(res, ms));
            const fs = require('fs-extra');
            const join = require('path').join;
            const twitchappapi = require('twitchappapi');
            const fetch = require('node-fetch');
            const Dialogs = require('dialogs');
            const dialogs = Dialogs();

            let Store = require('../../dest/store.js').Store;
            let instanceManager = require('../../dest/instanceManager.js');
            let ipcRenderer = require('electron').ipcRenderer;
            const remote = require('electron').remote;

            var cursorX;
            var cursorY;

            window.addEventListener("contextmenu", (e) =>
            {
                if(e.path[0].nodeName == 'HTML' || e.path[0].nodeName == 'DIV')
                {
                    let bawdy = document.getElementById('bawdy');
                    let added = `
                    <div onmouseleave="this.remove()" class="rc-menu" style="position: absolute; left: ${cursorX - 10}px; top: ${cursorY - 10}px;">
                        <a href="#" class="rc-menu-item" onclick="this.parentElement.remove();window.open('newinstance.html', '_blank', 'nodeIntegration=yes');">New Instance</a>
                        <a href="#" class="rc-menu-item" onclick="this.parentElement.remove();importPack();">Import Pack</a>
                        <a href="#" class="rc-menu-item" onclick="this.parentElement.remove();shell.openItem(join(instanceManager.getWorkingDir(), 'instances'));">Open Instances Folder</a>
                    </div>`;

                    bawdy.innerHTML += added;
                    e.stopPropagation();
                }
            }, true);

            function refreshVersions()
            {
                ipcRenderer.send('refreshVersions', {});
            }

            function openUserMenu()
            {
                document.getElementById('navbar').innerHTML += `
                <div onmouseleave="this.remove()" class="rc-menu" style="position: absolute; left: ${cursorX - 140}px; top: ${cursorY - 10}px; z-index: 2;">
                    <a href="#" class="rc-menu-item" onclick="window.open('settings.html', '_blank', 'nodeIntegration=yes');this.parentElement.remove();">Settings</a>
                    <a href="#" class="rc-menu-item" onclick="refreshVersions();this.parentElement.remove();">Refresh Versions</a>
                    <a href="#" class="rc-menu-item" onclick="this.parentElement.remove();importPack();">Import Pack</a>
                    <a href="#" class="rc-menu-item" onclick="logout();this.parentElement.remove();">Logout</a>
                    <a href="#" class="rc-menu-item" onclick="window.open('about.html', '_blank', 'nodeIntegration=yes');this.parentElement.remove();">About</a>
                    <a href="#" class="rc-menu-item inst-menu-item-launched" onclick="remote.getCurrentWindow().openDevTools();this.parentElement.remove();">Open DevTools</a>
                </div>`;
            }

            function logout()
            {
                store.set('profile', undefined); 
		        remote.getCurrentWindow().loadURL(`file://${__dirname}/login.html?flash=${encodeURI('Logged out successfully!<br> Login again.')}`);
            }

            async function downloadFile(target, url)
            {
                console.log('Downloading ' + url + ' to ' + target);
                const res = await fetch(url);
                return await new Promise((resolve, reject) => 
                {
                    const fileStream = fs.createWriteStream(target);
                    res.body.pipe(fileStream);
                    res.body.on("error", (err) => 
                    {
                        console.log('Could not download ' + url);
                        reject(err);
                    });
                    fileStream.on("finish", function() 
                    {
                        console.log('Downloaded ' + url);
                        resolve();
                    });
                });
            }

            async function longCatToggle()
            {
                let elem = document.getElementById('longcat').style;
                if(elem.display == 'none')
                {
                    elem.display = 'block';
                } else elem.display = 'none';
            }

            document.onmousemove = function(e)
            {
                cursorX = e.pageX;
                cursorY = e.pageY;
            }

            let store = new Store(
            {
                configName: 'user-data',
                defaults: {}
            });

            let profile = store.get('profile');
            let username;
            try {
                username = profile.profiles[0].name;
            } catch (error) 
            {
                username = profile.selectedProfile.name;
            }

            document.getElementById('profpic').src = "https://minotar.net/avatar/"+username+"/48.png";

            loadInstances();

            const updateInterval = setInterval(loadInstances, 2000);
            const { dialog } = require('electron').remote;
            var AdmZip = require('adm-zip');

            async function importPack()
            {
                let zipFile = dialog.showOpenDialog({title: 'Select Curse Modpack ZIP', properties: ['openFile'], filters: [{ name: 'Zip Files', extensions: ['zip'] }]});
                if(!zipFile) return;
                zipFile = zipFile[0];

                try 
                {
                    let zip = new AdmZip(zipFile);
                    let zipEntries = zip.getEntries();
                    let manifest = undefined;
                    let mmcPack = undefined;
                    let mmcPackName = undefined;

                    for (let i = 0; i < zipEntries.length; i++) 
                    {
                        const zipEntry = zipEntries[i];
                        if(zipEntry.entryName.toLowerCase().trim() == 'manifest.json')
                        {
                            manifest = JSON.parse(zipEntry.getData().toString('utf8'));
                        }

                        if(zipEntry.entryName.toLowerCase().trim().includes('mmc-pack.json'))
                        {
                            mmcPack = JSON.parse(zipEntry.getData().toString('utf8'));   
                            mmcPackName = zipEntry.entryName.trim().replace('/', '').replace('mmc-pack.json', '');
                        }
                    }

                    if(!manifest && !mmcPack)
                    {
                        throw new Error('Did not find manifest.json or mmc-pack.json in the zip file!');
                    }

                    if(!manifest && mmcPack)
                    {
                        manifest = 
                        {
                            name: mmcPackName,
                            overrides: '.minecraft',
                            mmcPack: true,
                            files: []
                        }

                        let mcVersion = mmcPack.components.filter(obj => obj.cachedName == "Minecraft")[0];
                        let forge = mmcPack.components.filter(obj => obj.cachedName == "Forge")[0];

                        manifest.minecraft = {version: mcVersion.version};
                        manifest.minecraft.modLoaders = [];
                        if(forge)
                        {
                            manifest.minecraft.modLoaders.push({id: 'forge-' + forge.version});
                        }
                    }
                    
                    if(!manifest.minecraft) throw new Error('Manifest.json did not have minecraft object.');

                    let mcVersion = store.get('versions').versions.filter(version => version.id == manifest.minecraft.version)[0];
                    let forgeVersion = undefined;

                    if(manifest.minecraft.modLoaders.length)
                    {
                        let forgeVersionNeeded = manifest.minecraft.modLoaders[0].id.split('-')[1].trim();
                        forgeVersion = store.get('forgeVersions')[mcVersion.id].versions.filter(forge => forge.version == forgeVersionNeeded)[0];
                    }

                    console.log({mcVersion: mcVersion, forgeVersion: forgeVersion});

                    let name = manifest.name.toLowerCase().replace(/[/\\?%*:|"<>]/g, "").replace(/'/g, '').replace('"', '').substring(0, 20).trim();
                    let instances = instanceManager.getInstances();

					for(var inst in instances)
					{
						inst = instances[inst];
						if(inst.folder == name)
						{
                            alert('Instance with the folder name ' + name + ' already exists!');
							return;
						}
					}

                    ipcRenderer.send('newInstance', {name: manifest.name.trim().substring(0, 20), version: mcVersion, forgeVersion: forgeVersion, dontMarkDone: true});
                    await timeout(1000);
                    let instDir = join(instanceManager.getWorkingDir(), 'instances', name);
                    let modsDir = join(instDir, 'mods');

                    if(manifest.overrides)
                    {
                        console.log(manifest.overrides);

                        for (let i = 0; i < zipEntries.length; i++) 
                        {
                            const zipEntry = zipEntries[i];
                            if(zipEntry.entryName.includes('info.json')) continue;
                            if(zipEntry.entryName.startsWith(manifest.overrides) || (manifest.mmcPack && zipEntry.entryName.includes(manifest.overrides))) 
                            {
                                zip.extractEntryTo(zipEntry.entryName, instDir, /*maintainEntryPath*/true, /*overwrite*/true);
                            }
                        }

                        let overrides = manifest.mmcPack ? join(instDir, mmcPackName, manifest.overrides) : join(instDir, manifest.overrides);
                        let files = fs.readdirSync(overrides);

                        files.forEach(file =>
                        {
                            if(file.includes('info.json')) return;
                            fs.move(join(overrides, file), join(instDir, file), {overwrite: true});
                        });
                    }

                    if(!fs.existsSync(modsDir)) fs.mkdirSync(modsDir);
                    
                    let promises = [];
                    let mods = {};

                    for (let i = 0; i < manifest.files.length; i++) 
                    {
                        const file = manifest.files[i];
                        
                        if(file.required)
                        {
                            let dl = await twitchappapi.getAddonFileInformation(file.projectID, file.fileID);
                            let prm = downloadFile(join(modsDir, dl.fileName), dl.downloadUrl);
                            promises.push(prm);
                            let info = await twitchappapi.getAddonInfo(file.projectID);
                            mods[dl.fileName.toLowerCase().trim()] = {info: info, name: info.name, url: info.websiteUrl, fileInfo: dl};
                        }
                    }

                    Promise.all(promises).then(() =>
                    {
                        let json = JSON.parse(fs.readFileSync(join(instDir, 'info.json')));
                        json.downloading = false;
                        fs.writeFileSync(join(instDir, 'info.json'), JSON.stringify(json));
                        fs.writeFileSync(join(instDir, 'mods.json'), JSON.stringify(mods));
                        console.log('Set info.json downloading = false and saved instance mods.json');
                    }).catch(err =>
                    {
                        console.log(err);
                        alert('Could not download modpack! ' + err.message);
                    });

                } catch (error) 
                {
                    alert('Invalid zip file! ' + error.message);    
                }
            }

            function loadInstances()
            {
                store = new Store(
                {
                    configName: 'user-data',
                    defaults: {}
                });

                let container = document.getElementById('instances');
                while (container.firstChild) container.removeChild(container.firstChild);
               
                let instances = instanceManager.getInstances();

                // for(var inst in instances)
                // {
                //     let instance = instances[inst];
                //     if(!instance.info.dateCreated)
                //     {
                //         console.log('instance ' + instance.info.name + ' did not have dateCreated');
                //         let instanceFolder = join(instanceManager.getWorkingDir(), 'instances', instance.info.name, 'info.json');
                //         let infoJson = JSON.parse(fs.readFileSync(instanceFolder));
                //         console.log(infoJson);
                //         infoJson.info.dateCreated = new Date().getTime();
                //         fs.writeFileSync(instanceFolder, JSON.stringify(infoJson));
                //     }
                // }

                let counter = 0;
                for(var inst in instances)
                {
                    inst = instances[inst];

                    let status = inst.info.downloading ? "downloading.jpg":"dirtblock.jpg";

                    container.innerHTML += `
                <article class="location-listing">
                    <a class="location-title" href="#" oncontextmenu="return openMenu('${inst.folder}')" ondblclick="launchInstance('${inst.folder}')">${inst.info.displayName}</a>
                    <div class="location-image">
                    <a href="#" oncontextmenu="return openMenu('${inst.folder}')" onclick="launchInstance('${inst.folder}')">
                        <img src="img/${status}" alt="${inst.info.name}">
                    </a>
                    </div>
                </article>`;

                    counter++;
                }
            }

            function launchInstance(name)
            {
                if(store.get('playing').playing) return alert('An instance is already running!');

                let instances = instanceManager.getInstances();

                let inst = instances[name];
                if(!inst) return;
                if(inst.info.downloading) return alert('The Instance is Currently Downloading!');
                
                let win = new remote.BrowserWindow(
                    {
                        width: 800,
                        height: 500,
                        x: 50,
                        y: 50,
                        webPreferences: {nodeIntegration: true}
                    }
                );
                win.loadURL(`file://${__dirname}/console.html?name=${encodeURI(name)}`);
   
                win.on('close', event => 
                {
                    console.log('event');
                    event.preventDefault();
                    win.hide();
                });
            }

            ipcRenderer.on('launchInstance', async (event, data) =>
            {
                console.log('launch: ' + data.name);
                launchInstance(data.name);
            });

            function openMenu(name)
            {
                let instances = instanceManager.getInstances();

                store = new Store(
                {
                    configName: 'user-data',
                    defaults: {}
                });
                
                let inst = instances[name];
                if(!inst) return;
                if(inst.info.downloading) return alert('The Instance is Currently Downloading!');

                let bawdy = document.getElementById('bawdy');

                let extra = store.get('playing').playing ? '':`
                <a href="#" class="rc-menu-item" onclick="deleteInstance('${name}');this.parentElement.remove();">Delete instance</a>
                `;

                let added = `
                <div onmouseleave="this.remove()" class="rc-menu" style="position: absolute; left: ${cursorX - 10}px; top: ${cursorY - 10}px;">
                    ${extra ? '<a href="#" class="rc-menu-item" onclick="renameInstance(\''+ name +'\');this.parentElement.remove();">Rename</a>':''}
                    ${inst.info.forge ? '<a href="#" class="rc-menu-item" onclick="openModManager(\''+name+'\');this.parentElement.remove();">Mod Manager</a>':''}
                    <a href="#" class="rc-menu-item" onclick="openFolder('${name}');this.parentElement.remove();">Open Folder</a>
                    ${extra}
                </div>`;

                bawdy.innerHTML += added;
            }

            deleteFolderRecursive = function(path) 
            {
                var files = [];
                if( fs.existsSync(path) ) 
                {
                    files = fs.readdirSync(path);
                    files.forEach(function(file,index)
                    {
                        var curPath = path + "/" + file;
                        if(fs.lstatSync(curPath).isDirectory()) 
                        { // recurse
                            deleteFolderRecursive(curPath);
                        } else 
                        { // delete file
                            fs.unlinkSync(curPath);
                        }
                    });
                    fs.rmdirSync(path);
                }
            };

            async function renameInstance(name)
            {
                let instances = instanceManager.getInstances();

                let inst = instances[name];
                if(!inst) return;
                if(inst.info.downloading) return alert('The Instance is Currently Downloading!');

                let newName = await dialogs.prompt('Enter new instance name', inst.info.displayName);
                if(!newName) return;

                let nameLowerCase = newName.toLowerCase().replace(/[/\\?%*:|"<>]/g, "").replace(/'/g, '').replace('"', '').substring(0, 20).trim();

                let instDir = join(instanceManager.getWorkingDir(), 'instances', name);
                let json = JSON.parse(fs.readFileSync(join(instDir, 'info.json')));
                json.name = nameLowerCase;
                json.displayName = newName.substring(0, 20).trim();

                fs.writeFileSync(join(instDir, 'info.json'), JSON.stringify(json));

                fs.move(instDir, join(instanceManager.getWorkingDir(), 'instances', nameLowerCase));
            }

            function deleteInstance(name)
            {
                let instances = instanceManager.getInstances();

                let inst = instances[name];
                if(!inst) return;
                if(inst.info.downloading) return alert('The Instance is Currently Downloading!');

                if(confirm('Do you really want to delete the instance "' + inst.info.displayName + '"?'))
                {
                    console.log('Deleting instance ' + name);

                    deleteFolderRecursive(join(instanceManager.getWorkingDir(), 'instances', inst.folder));
                }
            }

            async function openModManager(name)
            {
                let instances = instanceManager.getInstances();

                let inst = instances[name];
                if(!inst) return;
                if(inst.info.downloading) return alert('The Instance is Currently Downloading!');

                let win = await window.open('modManager.html?name='+encodeURI(name), '_blank', 'nodeIntegration=yes, width=895, height=540');
             
                ipcRenderer.on('stoppedPlaying', async (event, data) =>
                {
                    win.eval(`
                    btn = document.getElementById('btn-launch');
                    btn.classList.toggle('inst-menu-item-launch');
                    btn.classList.toggle('inst-menu-item-launched');
                    btn.disabled = false;`);
                });
            }

            const { shell } = require('electron');
            function openFolder(name)
            {
                let instances = instanceManager.getInstances();

                let inst = instances[name];
                if(!inst) return;
                
                shell.openItem(join(instanceManager.getWorkingDir(), 'instances', inst.folder));
            }
        </script>

        <a href="#" onclick="window.open('newinstance.html', '_blank', 'nodeIntegration=yes')" class="float"><i class="fa fa-plus my-float"></i></a>

        <div class="longcat" id="longcat" style="position: absolute; top: 100px; left: 70%; z-index: 2; display: none;">
            <img src="img/verylongcat.png">
        </div>
    </body>
</html>